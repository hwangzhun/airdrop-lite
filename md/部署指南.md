# AirDrop-Lite éƒ¨ç½²æŒ‡å—

æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨ç¼–è¯‘é¡¹ç›®å¹¶éƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šã€‚

## ğŸ“‹ å‰ç½®è¦æ±‚

- Node.js 18+ å·²å®‰è£…
- æœåŠ¡å™¨å·²å®‰è£… Node.js å’Œ npm
- æœåŠ¡å™¨å¯ä»¥è®¿é—®äº’è”ç½‘ï¼ˆç”¨äºä¸‹è½½ä¾èµ–ï¼‰

## ğŸ—ï¸ æœ¬åœ°ç¼–è¯‘æ­¥éª¤

### 1. å®‰è£…ä¾èµ–

```bash
npm install
```

### 2. æ„å»ºå‰ç«¯å¹¶æ‰“åŒ…éƒ¨ç½²æ–‡ä»¶

**æ–¹å¼ä¸€ï¼šä¸€é”®æ„å»ºå’Œæ‰“åŒ…ï¼ˆæ¨èï¼‰**
```bash
npm run build:deploy
```

**æ–¹å¼äºŒï¼šåˆ†æ­¥æ‰§è¡Œ**
```bash
# 1. æ„å»ºå‰ç«¯
npm run build

# 2. æ‰“åŒ…éƒ¨ç½²æ–‡ä»¶ï¼ˆåŒ…å«å‰ç«¯å’Œåç«¯ï¼‰
npm run package
```

æ‰“åŒ…å®Œæˆåï¼Œä¼šåœ¨ `deploy/` ç›®å½•ç”Ÿæˆå®Œæ•´çš„éƒ¨ç½²åŒ…ï¼ŒåŒ…å«ï¼š
- `dist/` - å‰ç«¯æ„å»ºäº§ç‰©ï¼ˆå·²ç¼–è¯‘ï¼‰
- `backend/` - åç«¯ä»£ç ï¼ˆ.cjs æ–‡ä»¶ï¼Œ**æ— éœ€ç¼–è¯‘**ï¼Œå¯ç›´æ¥è¿è¡Œï¼‰
- `server.cjs` - æœåŠ¡å™¨å…¥å£æ–‡ä»¶
- `ecosystem.config.cjs` - PM2 é…ç½®æ–‡ä»¶
- `package.json` å’Œ `package-lock.json` - ä¾èµ–é…ç½®

**é‡è¦è¯´æ˜**ï¼š
- **å‰ç«¯**ï¼šTypeScript/React ä»£ç éœ€è¦ç¼–è¯‘æˆé™æ€æ–‡ä»¶ï¼ˆ`dist/` ç›®å½•ï¼‰
- **åç«¯**ï¼š`.cjs` æ–‡ä»¶æ˜¯ JavaScriptï¼Œ**ä¸éœ€è¦ç¼–è¯‘**ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œ
- å‰ç«¯ä»£ç å·²é…ç½®ä¸ºï¼š
  - **å¼€å‘ç¯å¢ƒ**: ä½¿ç”¨ `http://localhost:3001` è¿æ¥åç«¯ API
  - **ç”Ÿäº§ç¯å¢ƒ**: ä½¿ç”¨ç›¸å¯¹è·¯å¾„ `/api` è¿æ¥åç«¯ APIï¼ˆå‰åç«¯åŒåŸŸï¼‰

å¦‚æœæ‚¨çš„ç”Ÿäº§ç¯å¢ƒå‰åç«¯ä¸åœ¨åŒä¸€åŸŸåï¼Œéœ€è¦ä¿®æ”¹ `services/localFileService.ts`ã€`services/authService.ts` å’Œ `services/storageService.ts` ä¸­çš„ API åœ°å€ã€‚

## ğŸš€ æœåŠ¡å™¨éƒ¨ç½²æ­¥éª¤

### å¿«é€Ÿéƒ¨ç½²ï¼ˆä½¿ç”¨è„šæœ¬ï¼‰

**Windows:**
```bash
deploy.bat
```

**Linux/Mac:**
```bash
chmod +x deploy.sh
./deploy.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆï¼š
- å®‰è£…ä¾èµ–
- æ„å»ºå‰ç«¯
- åˆ›å»ºå¿…è¦ç›®å½•
- å¯åŠ¨æœåŠ¡ï¼ˆå¦‚æœå®‰è£…äº† PM2ï¼‰

### æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨ PM2 éƒ¨ç½²ï¼ˆæ¨èï¼‰

#### 1. ä¸Šä¼ éƒ¨ç½²åŒ…åˆ°æœåŠ¡å™¨

**æ¨èæ–¹å¼**ï¼šä½¿ç”¨æ‰“åŒ…è„šæœ¬ç”Ÿæˆçš„ `deploy/` ç›®å½•

åœ¨æœ¬åœ°è¿è¡Œæ‰“åŒ…å‘½ä»¤åï¼Œå°†æ•´ä¸ª `deploy/` ç›®å½•ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼š

```bash
# æœ¬åœ°æ‰§è¡Œæ‰“åŒ…
npm run build:deploy

# ç„¶åå°† deploy/ ç›®å½•ä¸Šä¼ åˆ°æœåŠ¡å™¨
```

`deploy/` ç›®å½•ç»“æ„ï¼š
```
deploy/
â”œâ”€â”€ dist/                    # å‰ç«¯æ„å»ºäº§ç‰©ï¼ˆå·²ç¼–è¯‘ï¼‰
â”œâ”€â”€ backend/                 # åç«¯ä»£ç ï¼ˆ.cjs æ–‡ä»¶ï¼Œæ— éœ€ç¼–è¯‘ï¼‰
â”‚   â”œâ”€â”€ authRoutes.cjs
â”‚   â”œâ”€â”€ authService.cjs
â”‚   â”œâ”€â”€ db.cjs
â”‚   â”œâ”€â”€ filesRepository.cjs
â”‚   â”œâ”€â”€ filesRoutes.cjs
â”‚   â””â”€â”€ sessionService.cjs
â”œâ”€â”€ data/                    # æ•°æ®ç›®å½•ï¼ˆä¼šè‡ªåŠ¨åˆ›å»ºï¼‰
â”œâ”€â”€ uploadfiles/             # ä¸Šä¼ æ–‡ä»¶ç›®å½•ï¼ˆä¼šè‡ªåŠ¨åˆ›å»ºï¼‰
â”œâ”€â”€ logs/                    # æ—¥å¿—ç›®å½•ï¼ˆä¼šè‡ªåŠ¨åˆ›å»ºï¼‰
â”œâ”€â”€ server.cjs               # æœåŠ¡å™¨å…¥å£æ–‡ä»¶
â”œâ”€â”€ ecosystem.config.cjs     # PM2 é…ç½®æ–‡ä»¶
â”œâ”€â”€ package.json
â”œâ”€â”€ package-lock.json
â””â”€â”€ README-DEPLOY.md         # éƒ¨ç½²è¯´æ˜
```

**æ³¨æ„**ï¼šåç«¯ä»£ç æ˜¯ `.cjs` æ–‡ä»¶ï¼ˆCommonJSï¼‰ï¼Œ**ä¸éœ€è¦ç¼–è¯‘**ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚

#### 2. åœ¨æœåŠ¡å™¨ä¸Šå®‰è£…ä¾èµ–

```bash
# å¦‚æœä¸Šä¼ çš„æ˜¯ deploy/ ç›®å½•ï¼Œè¿›å…¥è¯¥ç›®å½•
cd /path/to/deploy

# å®‰è£…ç”Ÿäº§ä¾èµ–ï¼ˆä¸å®‰è£…å¼€å‘ä¾èµ–ï¼‰
npm install --production
```

**æ³¨æ„**ï¼šåªéœ€è¦å®‰è£…ä¾èµ–ï¼Œ**ä¸éœ€è¦ç¼–è¯‘åç«¯ä»£ç **ï¼Œå› ä¸ºåç«¯æ˜¯ `.cjs` æ–‡ä»¶ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚

#### 3. å®‰è£… PM2ï¼ˆè¿›ç¨‹ç®¡ç†å™¨ï¼‰

```bash
npm install -g pm2
```

#### 4. ç¡®è®¤æœåŠ¡å™¨æ–‡ä»¶

æ‰“åŒ…è„šæœ¬å·²ç»åŒ…å«äº† `server.cjs` æ–‡ä»¶ï¼ˆç”Ÿäº§ç¯å¢ƒä¼˜åŒ–ç‰ˆæœ¬ï¼‰ï¼Œæ— éœ€æ‰‹åŠ¨åˆ›å»ºã€‚

å¦‚æœ `deploy/` ç›®å½•ä¸­æ²¡æœ‰ `server.cjs`ï¼Œå¯ä»¥æ‰‹åŠ¨åˆ›å»ºï¼ˆåŸºäº `server-example.cjs`ï¼‰ï¼š

```javascript
const express = require('express');
const multer = require('multer');
const cookieParser = require('cookie-parser');
const fs = require('fs');
const path = require('path');
const filesRouter = require('./backend/filesRoutes.cjs');
const authRouter = require('./backend/authRoutes.cjs');

const app = express();
const PORT = process.env.PORT || 3001;

// ç¡®ä¿å¿…è¦çš„ç›®å½•å­˜åœ¨
const UPLOAD_DIR = path.join(__dirname, 'uploadfiles');
const DATA_DIR = path.join(__dirname, 'data');

[UPLOAD_DIR, DATA_DIR].forEach(dir => {
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true });
  }
});

// é…ç½® multer
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, UPLOAD_DIR);
  },
  filename: (req, file, cb) => {
    const customPath = req.body?.path;
    if (customPath && typeof customPath === 'string') {
      cb(null, customPath);
    } else {
      const timestamp = Date.now();
      const ext = path.extname(file.originalname) || '.bin';
      cb(null, `fallback_${timestamp}${ext}`);
    }
  }
});

const upload = multer({ storage });

// CORS é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®æŒ‡å®šå…·ä½“åŸŸåï¼‰
app.use((req, res, next) => {
  const origin = req.headers.origin;
  const allowedOrigins = process.env.ALLOWED_ORIGINS 
    ? process.env.ALLOWED_ORIGINS.split(',')
    : ['*'];
  
  if (allowedOrigins.includes('*') || (origin && allowedOrigins.includes(origin))) {
    res.header('Access-Control-Allow-Origin', origin || '*');
  }
  
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, PATCH, DELETE, OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization');
  res.header('Access-Control-Allow-Credentials', 'true');
  
  if (req.method === 'OPTIONS') {
    return res.sendStatus(200);
  }
  next();
});

app.use(express.json({ limit: '50mb' }));
app.use(express.urlencoded({ extended: true, limit: '50mb' }));
app.use(cookieParser());

// API è·¯ç”±
app.use('/api/files', filesRouter);
app.use('/api/auth', authRouter);

// æ–‡ä»¶ä¸Šä¼ æ¥å£
app.post('/api/upload', upload.single('file'), (req, res) => {
  if (!req.file) {
    return res.status(400).json({ error: 'æ²¡æœ‰æ–‡ä»¶è¢«ä¸Šä¼ ' });
  }
  const filePath = req.file.filename;
  const fileUrl = `/uploadfiles/${filePath}`;
  res.json({
    success: true,
    url: fileUrl,
    path: filePath
  });
});

// æ–‡ä»¶åˆ é™¤æ¥å£
app.delete('/api/delete', (req, res) => {
  const { path: filePath } = req.body;
  if (!filePath) {
    return res.status(400).json({ error: 'ç¼ºå°‘æ–‡ä»¶è·¯å¾„å‚æ•°' });
  }
  const fullPath = path.join(UPLOAD_DIR, filePath);
  if (!fullPath.startsWith(UPLOAD_DIR)) {
    return res.status(403).json({ error: 'éæ³•è·¯å¾„' });
  }
  fs.unlink(fullPath, (err) => {
    if (err) {
      if (err.code === 'ENOENT') {
        return res.status(404).json({ error: 'æ–‡ä»¶ä¸å­˜åœ¨' });
      }
      return res.status(500).json({ error: 'åˆ é™¤å¤±è´¥' });
    }
    res.json({ success: true });
  });
});

// é™æ€æ–‡ä»¶æœåŠ¡ï¼ˆä¸Šä¼ çš„æ–‡ä»¶ï¼‰
app.use('/uploadfiles', express.static(UPLOAD_DIR, {
  setHeaders: (res, filePath) => {
    const fileName = path.basename(filePath);
    res.setHeader('Content-Disposition', `attachment; filename="${fileName}"`);
  }
}));

// å‰ç«¯é™æ€æ–‡ä»¶æœåŠ¡ï¼ˆå¿…é¡»åœ¨æœ€åï¼‰
app.use(express.static(path.join(__dirname, 'dist')));

// å‰ç«¯è·¯ç”±å›é€€ï¼ˆSPA æ”¯æŒï¼‰
app.get('*', (req, res) => {
  // æ’é™¤ API è·¯ç”±
  if (req.path.startsWith('/api/')) {
    return res.status(404).json({ error: 'API è·¯ç”±ä¸å­˜åœ¨' });
  }
  res.sendFile(path.join(__dirname, 'dist', 'index.html'));
});

app.listen(PORT, () => {
  console.log(`æœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£ ${PORT}`);
  console.log(`ä¸Šä¼ ç›®å½•: ${UPLOAD_DIR}`);
  console.log(`æ•°æ®ç›®å½•: ${DATA_DIR}`);
});
```

#### 5. åˆ›å»º PM2 é…ç½®æ–‡ä»¶

åˆ›å»º `ecosystem.config.cjs`ï¼š

```javascript
module.exports = {
  apps: [{
    name: 'airdrop-lite',
    script: './server.cjs',
    instances: 1,
    exec_mode: 'fork',
    env: {
      NODE_ENV: 'production',
      PORT: 3001,
      ALLOWED_ORIGINS: '*' // ç”Ÿäº§ç¯å¢ƒå»ºè®®è®¾ç½®ä¸ºå…·ä½“åŸŸåï¼Œå¦‚: 'https://yourdomain.com,https://www.yourdomain.com'
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,
    autorestart: true,
    watch: false,
    max_memory_restart: '500M'
  }]
};
```

#### 6. åˆ›å»ºæ—¥å¿—ç›®å½•

```bash
mkdir -p logs
```

#### 7. å¯åŠ¨æœåŠ¡

```bash
pm2 start ecosystem.config.cjs
```

#### 8. è®¾ç½®å¼€æœºè‡ªå¯

```bash
pm2 startup
pm2 save
```

#### 9. å¸¸ç”¨ PM2 å‘½ä»¤

```bash
# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs airdrop-lite

# é‡å¯æœåŠ¡
pm2 restart airdrop-lite

# åœæ­¢æœåŠ¡
pm2 stop airdrop-lite

# åˆ é™¤æœåŠ¡
pm2 delete airdrop-lite
```

### æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ Nginx åå‘ä»£ç†ï¼ˆæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰

#### 1. å®‰è£… Nginx

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install nginx

# CentOS/RHEL
sudo yum install nginx
```

#### 2. é…ç½® Nginx

åˆ›å»º `/etc/nginx/sites-available/airdrop-lite`ï¼ˆæˆ–ç¼–è¾‘ç°æœ‰é…ç½®ï¼‰ï¼š

```nginx
server {
    listen 80;
    server_name your-domain.com;  # æ›¿æ¢ä¸ºæ‚¨çš„åŸŸå

    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        root /path/to/airdrop-lite/dist;
        try_files $uri $uri/ /index.html;
    }

    # ä¸Šä¼ çš„æ–‡ä»¶
    location /uploadfiles {
        alias /path/to/airdrop-lite/uploadfiles;
        add_header Content-Disposition 'attachment';
    }

    # API ä»£ç†
    location /api {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶
        client_max_body_size 50M;
    }

    # æ—¥å¿—
    access_log /var/log/nginx/airdrop-lite-access.log;
    error_log /var/log/nginx/airdrop-lite-error.log;
}
```

#### 3. å¯ç”¨é…ç½®

```bash
# åˆ›å»ºç¬¦å·é“¾æ¥ï¼ˆUbuntu/Debianï¼‰
sudo ln -s /etc/nginx/sites-available/airdrop-lite /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯ Nginx
sudo systemctl restart nginx
```

#### 4. é…ç½® HTTPSï¼ˆå¯é€‰ä½†æ¨èï¼‰

ä½¿ç”¨ Let's Encrypt å…è´¹ SSL è¯ä¹¦ï¼š

```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

### æ–¹æ¡ˆä¸‰ï¼šç›´æ¥è¿è¡Œï¼ˆç®€å•æµ‹è¯•ï¼‰

```bash
node server.cjs
```

## ğŸ”§ ç¯å¢ƒå˜é‡é…ç½®

åœ¨æœåŠ¡å™¨ä¸Šå¯ä»¥è®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

```bash
# ç«¯å£å·ï¼ˆé»˜è®¤ 3001ï¼‰
export PORT=3001

# å…è®¸çš„æºï¼ˆCORSï¼‰
export ALLOWED_ORIGINS=https://yourdomain.com,https://www.yourdomain.com

# Node ç¯å¢ƒ
export NODE_ENV=production
```

æˆ–åœ¨ `ecosystem.config.cjs` ä¸­é…ç½®ã€‚

## ğŸ“ éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] å‰ç«¯å·²æ„å»ºï¼ˆ`dist` ç›®å½•å­˜åœ¨ï¼‰
- [ ] åç«¯ä¾èµ–å·²å®‰è£…ï¼ˆ`npm install --production`ï¼‰
- [ ] å¿…è¦çš„ç›®å½•å·²åˆ›å»ºï¼ˆ`data/`, `uploadfiles/`, `logs/`ï¼‰
- [ ] æœåŠ¡å™¨æ–‡ä»¶å·²åˆ›å»ºï¼ˆ`server.cjs`ï¼‰
- [ ] PM2 é…ç½®æ–‡ä»¶å·²åˆ›å»ºï¼ˆ`ecosystem.config.cjs`ï¼‰
- [ ] æœåŠ¡å·²å¯åŠ¨å¹¶è¿è¡Œ
- [ ] é˜²ç«å¢™ç«¯å£å·²å¼€æ”¾ï¼ˆ3001 æˆ– 80/443ï¼‰
- [ ] åŸŸå DNS å·²é…ç½®ï¼ˆå¦‚æœä½¿ç”¨åŸŸåï¼‰

## ğŸ› å¸¸è§é—®é¢˜

### 1. ç«¯å£è¢«å ç”¨

```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
lsof -i :3001
# æˆ–
netstat -tulpn | grep 3001

# ä¿®æ”¹ server.cjs ä¸­çš„ PORT æˆ–ä½¿ç”¨ç¯å¢ƒå˜é‡
```

### 2. æ–‡ä»¶æƒé™é—®é¢˜

```bash
# ç¡®ä¿ç›®å½•æœ‰å†™æƒé™
chmod -R 755 uploadfiles
chmod -R 755 data
```

### 3. æ•°æ®åº“æ–‡ä»¶æƒé™

```bash
# SQLite æ•°æ®åº“éœ€è¦è¯»å†™æƒé™
chmod 664 data/files.db
```

### 4. æŸ¥çœ‹æ—¥å¿—

```bash
# PM2 æ—¥å¿—
pm2 logs airdrop-lite

# Nginx æ—¥å¿—
sudo tail -f /var/log/nginx/airdrop-lite-error.log
```

## ğŸ”„ æ›´æ–°éƒ¨ç½²

1. åœ¨æœ¬åœ°é‡æ–°æ„å»ºå’Œæ‰“åŒ…ï¼š
   ```bash
   npm run build:deploy
   ```

2. ä¸Šä¼  `deploy/` ç›®å½•ä¸­çš„æ›´æ–°æ–‡ä»¶åˆ°æœåŠ¡å™¨ï¼š
   - å¦‚æœåªæ›´æ–°äº†å‰ç«¯ï¼šä¸Šä¼  `deploy/dist/` ç›®å½•
   - å¦‚æœæ›´æ–°äº†åç«¯ï¼šä¸Šä¼  `deploy/backend/` ç›®å½•å’Œ `deploy/server.cjs`
   - å¦‚æœæ›´æ–°äº†ä¾èµ–ï¼šä¸Šä¼  `deploy/package.json` å’Œ `deploy/package-lock.json`ï¼Œç„¶ååœ¨æœåŠ¡å™¨è¿è¡Œ `npm install --production`

3. é‡å¯æœåŠ¡ï¼š
   ```bash
   pm2 restart airdrop-lite
   ```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
- PM2 æ—¥å¿—ï¼š`pm2 logs airdrop-lite`
- æœåŠ¡å™¨æ—¥å¿—ï¼š`./logs/err.log` å’Œ `./logs/out.log`
- Nginx æ—¥å¿—ï¼ˆå¦‚æœä½¿ç”¨ï¼‰ï¼š`/var/log/nginx/airdrop-lite-error.log`

